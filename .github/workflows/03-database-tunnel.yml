name: Deploy Case 2 - Database SSH Tunnel Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'GitHub Environment to use'
        required: true
        default: 'poc'
        type: choice
        options:
          - poc
          - production
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'eu-west-1'
        type: choice
        options:
          - eu-west-1
          - eu-central-1
          - us-east-1
          - us-west-2
      ssh_public_key:
        description: 'SSH public key for EC2 access (required)'
        required: true
        type: string

env:
  AWS_REGION: ${{ inputs.aws_region }}
  TF_VERSION: 1.6.0
  WORKING_DIR: 03-proxyjump-forwarding/terraform

jobs:
  terraform:
    name: Terraform ${{ inputs.action }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    permissions:
      id-token: write
      contents: read
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-DatabaseTunnel
      
      - name: Get configuration from AWS Secrets Manager
        id: get-config
        run: |
          SECRET=$(aws secretsmanager get-secret-value \
            --secret-id ssh-tips/github-actions-config \
            --region ${{ env.AWS_REGION }} \
            --query SecretString \
            --output text)
          
          TF_BUCKET=$(echo $SECRET | jq -r '.TF_STATE_BUCKET')
          ROLE_ARN=$(echo $SECRET | jq -r '.AWS_ROLE_ARN')
          
          echo "TF_STATE_BUCKET=$TF_BUCKET" >> $GITHUB_ENV
          echo "AWS_ROLE_ARN=$ROLE_ARN" >> $GITHUB_ENV
          
          # Mask sensitive values
          echo "::add-mask::$ROLE_ARN"
          echo "âœ… Configuration loaded from Secrets Manager"
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format
        id: fmt
        run: |
          terraform fmt
          terraform fmt -check
        continue-on-error: true
      
      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="bucket=$TF_STATE_BUCKET" \
            -backend-config="key=ssh-tips/03-proxyjump-forwarding/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
      
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
      
      - name: Terraform Plan
        id: plan
        if: inputs.action == 'apply'
        run: |
          terraform plan -no-color -input=false \
            -var="ssh_public_key=${{ inputs.ssh_public_key }}" \
            -out=tfplan
        continue-on-error: true
      
      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1
      
      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: terraform apply -auto-approve -input=false tfplan
      
      - name: Wait for user_data completion
        if: inputs.action == 'apply'
        run: |
          echo "Waiting for EC2 user_data to complete (MySQL client installation)..."
          sleep 90
      
      - name: Populate Database with Sample Data
        if: inputs.action == 'apply'
        run: |
          # Get credentials from Secrets Manager
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id ssh-tips/case02-database-credentials \
            --region ${{ env.AWS_REGION }} \
            --query SecretString --output text)
          
          DB_HOST=$(echo $SECRET_JSON | jq -r '.rds_endpoint' | cut -d: -f1)
          DB_NAME=$(echo $SECRET_JSON | jq -r '.db_name')
          DB_USER=$(echo $SECRET_JSON | jq -r '.db_username')
          DB_PASS=$(echo $SECRET_JSON | jq -r '.db_password')
          BASTION_IP=$(terraform output -raw bastion_public_ip)
          
          # Create SQL file
          cat > /tmp/populate_db.sql << 'EOSQL'
          CREATE TABLE IF NOT EXISTS employees (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            department VARCHAR(50) NOT NULL,
            salary DECIMAL(10, 2) NOT NULL,
            hire_date DATE NOT NULL
          );
          
          CREATE TABLE IF NOT EXISTS products (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            category VARCHAR(50) NOT NULL,
            price DECIMAL(10, 2) NOT NULL,
            stock INT NOT NULL
          );
          
          INSERT INTO employees (name, department, salary, hire_date) VALUES
          ('Alice Johnson', 'Engineering', 95000.00, '2020-01-15'),
          ('Bob Smith', 'Engineering', 85000.00, '2019-03-22'),
          ('Carol Williams', 'Marketing', 75000.00, '2021-06-10'),
          ('David Brown', 'Sales', 70000.00, '2018-11-05'),
          ('Eve Davis', 'Engineering', 105000.00, '2017-09-12'),
          ('Frank Miller', 'HR', 65000.00, '2020-02-28'),
          ('Grace Wilson', 'Engineering', 92000.00, '2019-07-19'),
          ('Henry Moore', 'Marketing', 78000.00, '2021-01-08'),
          ('Iris Taylor', 'Sales', 72000.00, '2020-05-14'),
          ('Jack Anderson', 'Engineering', 88000.00, '2018-12-03');
          
          INSERT INTO products (name, category, price, stock) VALUES
          ('Laptop Pro 15', 'Electronics', 1299.99, 45),
          ('Wireless Mouse', 'Electronics', 29.99, 150),
          ('USB-C Cable', 'Accessories', 12.99, 300),
          ('Mechanical Keyboard', 'Electronics', 89.99, 75),
          ('Monitor 27 inch', 'Electronics', 349.99, 30),
          ('Desk Lamp', 'Office', 39.99, 120),
          ('Office Chair', 'Office', 199.99, 25),
          ('Notebook A4', 'Stationery', 4.99, 500),
          ('Pen Set', 'Stationery', 9.99, 200),
          ('External SSD 1TB', 'Electronics', 129.99, 60);
          EOSQL
          
          # Setup SSH key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key.pem
          chmod 600 /tmp/ssh_key.pem
          
          # Copy SQL file to bastion
          scp -i /tmp/ssh_key.pem -o StrictHostKeyChecking=no /tmp/populate_db.sql ec2-user@${BASTION_IP}:/tmp/
          
          # Execute SQL on bastion (which connects to RDS)
          ssh -i /tmp/ssh_key.pem -o StrictHostKeyChecking=no ec2-user@${BASTION_IP} \
            "mysql -h ${DB_HOST} -u ${DB_USER} -p'${DB_PASS}' ${DB_NAME} < /tmp/populate_db.sql && rm /tmp/populate_db.sql"
          
          # Cleanup local files
          rm /tmp/ssh_key.pem /tmp/populate_db.sql
          
          echo "âœ… Database populated successfully!"
      
      - name: Delete Secrets Manager Secret (before destroy)
        if: inputs.action == 'destroy'
        run: |
          # Get secret name from terraform state
          SECRET_NAME=$(terraform output -raw secrets_manager_name 2>/dev/null || echo "ssh-tips/case02-database-credentials")
          
          echo "Deleting secret: $SECRET_NAME"
          aws secretsmanager delete-secret \
            --secret-id "$SECRET_NAME" \
            --force-delete-without-recovery \
            --region ${{ env.AWS_REGION }} || echo "Secret already deleted or not found"
        continue-on-error: true
      
      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: |
          terraform destroy -auto-approve -input=false \
            -var="ssh_public_key=${{ inputs.ssh_public_key }}"
      
      - name: Get Outputs
        if: inputs.action == 'apply'
        id: outputs
        run: |
          SECRET_NAME=$(terraform output -raw secrets_manager_name)
          echo "secrets_manager_name=$SECRET_NAME" >> $GITHUB_OUTPUT
          echo "bastion_public_ip=$(terraform output -raw bastion_public_ip)" >> $GITHUB_OUTPUT
          
          # Retrieve credentials from Secrets Manager
          SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "$SECRET_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query SecretString \
            --output text)
          
          # Parse JSON and set outputs
          echo "rds_address=$(echo $SECRET | jq -r '.rds_address')" >> $GITHUB_OUTPUT
          echo "rds_endpoint=$(echo $SECRET | jq -r '.rds_endpoint')" >> $GITHUB_OUTPUT
          echo "db_name=$(echo $SECRET | jq -r '.db_name')" >> $GITHUB_OUTPUT
          echo "db_username=$(echo $SECRET | jq -r '.db_username')" >> $GITHUB_OUTPUT
          echo "db_password=$(echo $SECRET | jq -r '.db_password')" >> $GITHUB_OUTPUT
          
          # Mask sensitive outputs
          DB_PASSWORD=$(echo $SECRET | jq -r '.db_password')
          echo "::add-mask::$DB_PASSWORD"
      
      - name: Display Connection Info
        if: inputs.action == 'apply'
        run: |
          echo "### ðŸš€ Infrastructure Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bastion Public IP:** ${{ steps.outputs.outputs.bastion_public_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "**RDS Endpoint:** ${{ steps.outputs.outputs.rds_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ” Credentials Storage:" >> $GITHUB_STEP_SUMMARY
          echo "All credentials stored in AWS Secrets Manager:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.outputs.outputs.secrets_manager_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“‹ Retrieve All Credentials:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "aws secretsmanager get-secret-value \\" >> $GITHUB_STEP_SUMMARY
          echo "  --secret-id ${{ steps.outputs.outputs.secrets_manager_name }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --region ${{ env.AWS_REGION }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --query SecretString --output text | jq" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ”’ SSH Tunnel Command:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "ssh -i ~/.ssh/id_rsa -L 3306:${{ steps.outputs.outputs.rds_address }}:3306 -N ec2-user@${{ steps.outputs.outputs.bastion_public_ip }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ’¾ MySQL Connection (via tunnel):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "mysql -h 127.0.0.1 -P 3306 -u ${{ steps.outputs.outputs.db_username }} -p" >> $GITHUB_STEP_SUMMARY
          echo "# Password available in Secrets Manager" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ”§ DBeaver Connection Settings:" >> $GITHUB_STEP_SUMMARY
          echo "- **Host:** 127.0.0.1" >> $GITHUB_STEP_SUMMARY
          echo "- **Port:** 3306" >> $GITHUB_STEP_SUMMARY
          echo "- **Database:** ${{ steps.outputs.outputs.db_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Username:** ${{ steps.outputs.outputs.db_username }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Password:** *(retrieve from Secrets Manager)*" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** Establish SSH tunnel first before connecting with DBeaver!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“Š Sample Data Loaded:" >> $GITHUB_STEP_SUMMARY
          echo "- **employees** table: 10 records" >> $GITHUB_STEP_SUMMARY
          echo "- **products** table: 10 records" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ”‘ Quick Access (for demo):" >> $GITHUB_STEP_SUMMARY
          echo "**Database Name:** ${{ steps.outputs.outputs.db_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database Username:** ${{ steps.outputs.outputs.db_username }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database Password:** ${{ steps.outputs.outputs.db_password }}" >> $GITHUB_STEP_SUMMARY
